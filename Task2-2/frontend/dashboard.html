{% extends "base.html" %}
{% block content %}
<h2>Dashboard</h2>
<p>Choose an action:</p>
<ul class="list-group mb-4">
  <li class="list-group-item"><a href="{{ url_for('upload_file') }}">Upload a File</a></li>
  <li class="list-group-item"><a href="{{ url_for('create_folder') }}">Create a Folder</a></li>
  <li class="list-group-item"><a href="{{ url_for('get_account_info') }}">Get Account Info</a></li>
</ul>

<hr>

<h3>Dropbox Files & Folders</h3>

{% if current_path %}
<p><strong>Current path:</strong> /{{ current_path }}</p>
<a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm mb-3">‚¨Ö Back to Root</a>
{% endif %}

<ul class="list-group">
  {% for item in items %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span>
        {% if item['.tag'] == 'folder' %}
          üìÅ <a href="{{ url_for('dashboard', path=current_path ~ '/' ~ item['name'] if current_path else item['name']) }}">
            {{ item['name'] }}
          </a>
        {% else %}
          üìÑ {{ item['name'] }}
        {% endif %}
      </span>
      <div class="btn-group btn-group-sm">
        <button class="btn btn-warning rounded"
                data-path="{{ (current_path ~ '/' if current_path else '') ~ item['name'] }}"
                onclick="renameItem(this.getAttribute('data-path'))">
          Rename
        </button>
        <button class="btn btn-danger rounded"
                style="margin-left: 10px;"
                data-path="{{ (current_path ~ '/' if current_path else '') ~ item['name'] }}"
                onclick="deleteItem(this.getAttribute('data-path'))">
          Delete
        </button>
      </div>
    </li>
  {% endfor %}
</ul>

<script>
async function deleteItem(path) {
  if (!confirm(`Are you sure you want to delete ${path}?`)) return;

  try {
    const res = await fetch('/api/delete_file', {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({file_path: path})
    });

    const data = await res.json();
    if (res.ok) {
      alert(data.message);
      location.reload(); // refresh the page
    } else {
      alert(`Error: ${data.error}`);
    }
  } catch (err) {
    alert(`Error: ${err}`);
  }
}

async function renameItem(oldPath) {
  const newName = prompt(`Enter new name for "${oldPath}":`);
  if (!newName) return;

  try {
    const res = await fetch('/api/rename', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ old_path: oldPath, new_name: newName })
    });

    const data = await res.json();
    if (res.ok) {
      alert(data.message);
      location.reload();
    } else {
      alert(`Error: ${data.error}`);
    }
  } catch (err) {
    alert(`Error: ${err}`);
  }
}
</script>
{% endblock %}

